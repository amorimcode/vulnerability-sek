<template>
  <div class="flex flex-wrap border-2 px-4 py-8 rounded mx-4 text-gray-900">
    <div class="w-full md:w-1/2 lg:w-1/4 px-4">
      <div class="flex font-semibold justify-between">
        <p>Score</p>
        <p class="text-sm">Varia com os filtros selecionados</p>
      </div>
      <div class="h-10 bg-gray-200 rounded overflow-hidden mt-1">
        <div
          :style="barStyle(props.score)"
          class="h-full bg-solid-green text-center"
        >
          <p class="font-semibold p-2">
            {{ props.score }}
          </p>
        </div>
      </div>
    </div>

    <div class="w-full md:w-1/2 lg:w-1/4 px-4">
      <div class="flex font-semibold justify-between">
        <p>Alto</p>
        <span class="text-sm flex"
          ><p class="mr-1 text-solid-red">{{ resume.high.exposed }}</p>
          /
          <p class="ml-1">{{ resume.high.total }} Itens expostos</p></span
        >
      </div>
      <div class="h-10 bg-gray-200 rounded overflow-hidden mt-1">
        <div
          :style="barPercentStyle(resume.high.exposed, resume.high.total)"
          class="h-full bg-solid-red text-center"
        >
          <p class="font-semibold p-2">
            {{ getPercent(resume.high.exposed, resume.high.total) }}%
          </p>
        </div>
      </div>
    </div>

    <div class="w-full md:w-1/2 lg:w-1/4 px-4">
      <div class="flex font-semibold justify-between">
        <p>MÃ©dio</p>
        <span class="text-sm flex"
          ><p class="mr-1 text-solid-red">{{ resume.medium.exposed }}</p>
          /
          <p class="ml-1">{{ resume.low.total }} Itens expostos</p></span
        >
      </div>
      <div class="h-10 bg-gray-200 rounded overflow-hidden mt-1">
        <div
          :style="barPercentStyle(resume.medium.exposed, resume.medium.total)"
          class="h-full bg-solid-orange text-center"
        >
          <p class="font-semibold p-2">
            {{ getPercent(resume.medium.exposed, resume.medium.total) }}%
          </p>
        </div>
      </div>
    </div>

    <div class="w-full md:w-1/2 lg:w-1/4 px-4">
      <div class="flex font-semibold justify-between">
        <p>Baixo</p>
        <span class="text-sm flex"
          ><p class="mr-1 text-solid-red">
            {{ resume.high.exposed }}
          </p>
          /
          <p class="ml-1">{{ resume.high.total }} Itens expostos</p></span
        >
      </div>
      <div class="h-10 bg-gray-200 rounded overflow-hidden mt-1">
        <div
          :style="barPercentStyle(resume.low.exposed, resume.low.total)"
          class="h-full bg-solid-yellow text-center"
        >
          <p class="font-semibold p-2">
            {{ getPercent(resume.low.exposed, resume.low.total) }}%
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { CRITICALLY_LEVEL } from "~/enums";

const props = defineProps<{
  score: number;
  vulnerabilities: models.Vulnerability[];
}>();

const getPercent = (exposed: number, total: number) => {
  if (total === 0) {
    return 0;
  }
  return Math.round((exposed / total) * 100);
};

const filterAndReduceVulnerabilities = (
  vulnerabilities: models.Vulnerability[],
  criticallyLevel: CRITICALLY_LEVEL,
) => {
  return {
    total: vulnerabilities
      .filter(
        (vulnerability) => vulnerability.criticallyLevel === criticallyLevel,
      )
      .reduce((acc, curr) => acc + (curr.status?.total || 0), 0),
    exposed: vulnerabilities
      .filter(
        (vulnerability) => vulnerability.criticallyLevel === criticallyLevel,
      )
      .reduce((acc, curr) => acc + (curr.status?.exposed || 0), 0),
  };
};

const resume = {
  score: props.score,
  high: filterAndReduceVulnerabilities(
    props.vulnerabilities,
    CRITICALLY_LEVEL.HIGH,
  ),
  medium: filterAndReduceVulnerabilities(
    props.vulnerabilities,
    CRITICALLY_LEVEL.MEDIUM,
  ),
  low: filterAndReduceVulnerabilities(
    props.vulnerabilities,
    CRITICALLY_LEVEL.LOW,
  ),
};
</script>

<script lang="ts">
export default {
  methods: {
    barStyle(score: number) {
      const width = (score / 1000) * 100;
      return `width: ${width}%`;
    },
    barPercentStyle(exposed: number, total: number) {
      const width = (exposed / total) * 100;
      return `width: ${width}%`;
    },
  },
};
</script>
