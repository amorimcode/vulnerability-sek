<template>
  <el-table
    :data="tableData"
    class="border-2 rounded w-100 min-h-[400px]"
    :row-class-name="levelClassname"
    header-cell-class-name="bg-background text-gray-900"
  >
    <el-table-column width="70">
      <template #default="scope">
        <div
          :class="[
            'transform rotate-[270deg] text-background text-center',
            getSeverityClass(scope.row.criticallyLevel),
          ]"
        >
          <span>{{ getSeverity(scope.row.criticallyLevel) }}</span>
        </div>
      </template>
    </el-table-column>
    <el-table-column
      prop="description"
      label="Vulnerabilidade"
      min-width="300px"
    />
    <el-table-column prop="status" label="Status">
      <template #default="scope">
        <div class="text-sm pb-4 overflow-visible">
          <div class="flex justify-between font-semibold">
            <span
              >{{ scope.row.status.passed ?? "--" }}/{{
                scope.row.status.total ?? "--"
              }}</span
            >
            <span>{{
              getStatusText(scope.row.status.passed, scope.row.status.total) ??
              "--"
            }}</span>
          </div>
          <div class="text-center">
            <div class="h-1 bg-gray-200 rounded overflow-hidden mt-1">
              <div
                :style="
                  getBarWidth(scope.row.status.passed, scope.row.status.total)
                "
                :class="[
                  'h-full',
                  getStatusColorClass(
                    scope.row.status.passed,
                    scope.row.status.total,
                  ),
                ]"
              ></div>
            </div>
            <span>{{
              getStatusPercentage(
                scope.row.status.passed,
                scope.row.status.total,
              )
            }}</span>
          </div>
        </div>
      </template>
    </el-table-column>
  </el-table>
</template>

<script lang="ts" setup>
import { CRITICALLY_LEVEL } from "@/enums";

const tableData: models.Vulnerability[] = [
  {
    description: "Buckets S3 sem política de MFA Delete",
    criticallyLevel: CRITICALLY_LEVEL.HIGH,
    status: {
      passed: 10,
      total: 15,
    },
  },
  {
    description: "EC2 em subnet pública",
    criticallyLevel: CRITICALLY_LEVEL.HIGH,
    status: {
      passed: 10,
      total: 30,
    },
  },
  {
    description: "ELB aberto para a internet",
    criticallyLevel: CRITICALLY_LEVEL.MEDIUM,
    status: {
      passed: undefined,
      total: undefined,
    },
  },
];

const getSeverity = (criticallyLevel: CRITICALLY_LEVEL) => {
  if (criticallyLevel === CRITICALLY_LEVEL.HIGH) {
    return "Alto";
  }
  if (criticallyLevel === CRITICALLY_LEVEL.MEDIUM) {
    return "Médio";
  }
  if (criticallyLevel === CRITICALLY_LEVEL.LOW) {
    return "Baixo";
  }
  return "";
};

const getSeverityClass = (criticallyLevel: CRITICALLY_LEVEL) => {
  if (criticallyLevel === CRITICALLY_LEVEL.HIGH) {
    return "bg-solid-red";
  }
  if (criticallyLevel === CRITICALLY_LEVEL.MEDIUM) {
    return "bg-solid-orange";
  }
  if (criticallyLevel === CRITICALLY_LEVEL.LOW) {
    return "bg-solid-yellow";
  }
  return "";
};

const getStatusPercentage = (passed?: number, total?: number) => {
  if (!passed || !total) {
    return "---";
  }

  return `${((passed / total) * 100).toFixed(0)}%`;
};

const getBarWidth = (passed: number, total: number) => {
  return `$width ${((passed / total) * 100).toFixed(0)}%`;
};

const getStatusText = (passed?: number, total?: number) => {
  if (!passed || !total) {
    return "Falhando";
  }

  return passed === total ? "Ok" : "Falhando";
};

const getStatusColorClass = (passed: number, total: number) => {
  if (!passed && !total) {
    return "bg-gray-200";
  }

  return passed === total ? "bg-solid-green" : "bg-solid-red";
};

const levelClassname = (scope: any) => {
  return getSeverityClass(scope.row.criticallyLevel);
};
</script>
